<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reporting Vicidial — Pivot & Statistiques</title>
  <meta name="theme-color" content="#0b57d0" />

  <!-- SheetJS (XLSX import/export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2canvas for capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f5f8ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.62);
      --stroke:rgba(15,23,42,.10);
      --shadow:0 18px 60px rgba(0,0,0,.10);
      --blue:#0b57d0;
      --cyan:#00c2ff;
      --gold:#d4af37;
      --green:#16a34a;
      --red:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#f7fbff,#eef3ff);
      color:var(--text);
    }
    header{
      padding:18px 16px;
      background:linear-gradient(135deg,#071a3a,#0b57d0);
      color:#fff;
      position:sticky; top:0; z-index:50;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1200px; margin:auto;
    }
    .title{
      display:flex; flex-direction:column;
      gap:2px;
    }
    .title b{font-size:16px; letter-spacing:.2px}
    .title span{font-size:12px; opacity:.86}
    .wrap{max-width:1200px;margin:auto;padding:16px}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{position:relative}
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .row{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .btn{
      appearance:none;
      border:none;
      background:linear-gradient(90deg,var(--blue),#0ea5e9);
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(11,87,208,.20);
    }
    .btn.secondary{
      background:#fff;
      color:var(--text);
      border:1px solid var(--stroke);
      box-shadow:none;
      font-weight:800;
    }
    .btn.danger{
      background:linear-gradient(90deg,#b91c1c,#ef4444);
      box-shadow:0 10px 26px rgba(239,68,68,.18);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    input[type="file"]{display:none}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      font-size:12px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .kpi .label{font-size:11px;color:var(--muted);font-weight:800}
    .kpi .value{font-size:18px;font-weight:1000;margin-top:2px}
    .kpi .sub{font-size:11px;color:var(--muted);margin-top:2px}

    .filters{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    select, input[type="date"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:#fff;
      font-weight:800;
      outline:none;
    }
    .hint{
      font-size:12px;color:var(--muted);
      line-height:1.4;
    }

    .tableWrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--stroke);
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      min-width:1100px;
      background:#fff;
    }
    th, td{
      border-bottom:1px solid var(--stroke);
      padding:10px 10px;
      vertical-align:top;
      font-size:12px;
    }
    th{
      position:sticky; top:0;
      background:#f7faff;
      z-index:5;
      text-align:left;
      font-size:11px;
      color:rgba(11,18,32,.85);
      letter-spacing:.25px;
      white-space:nowrap;
    }
    tr:hover td{background:#fbfdff}
    .cellSmall{white-space:nowrap}
    .link{
      color:var(--blue);
      font-weight:900;
      text-decoration:none;
    }
    .in{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      outline:none;
      font:inherit;
      background:#fff;
    }
    textarea.in{min-height:44px; resize:vertical}
    .statusTag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:#fff;
      font-weight:900;
      font-size:11px;
      white-space:nowrap;
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#0b1220;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
      z-index:99;
    }
    .toast.show{opacity:1}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .modal{
      width:min(980px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid var(--stroke);
      box-shadow:0 30px 100px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      background:linear-gradient(135deg,#071a3a,#0b57d0);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead b{font-size:14px}
    .modalBody{padding:14px 16px}
    .mapGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .mapGrid{grid-template-columns:1fr} }
    .mapBox{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .mapBox h3{margin:0 0 8px;font-size:13px}
    .mapRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
      margin:8px 0;
    }
    .mapRow label{
      font-size:12px;
      color:rgba(11,18,32,.85);
      font-weight:900;
    }
    .mini{
      font-size:11px;color:var(--muted);margin-top:8px;line-height:1.4
    }
    .hr{height:1px;background:var(--stroke);margin:12px 0}
    .right{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.25);
      font-size:12px;
      font-weight:900;
    }

    /* History table */
    .histTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
    }
    .histTable th, .histTable td{font-size:12px}
    .histTable th{background:#f7faff}
    .smallActions{display:flex; gap:8px; flex-wrap:wrap}
    .tiny{
      padding:8px 10px;
      border-radius:12px;
      font-weight:900;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
    }
    .tiny.primary{
      color:#fff;
      border:none;
      background:linear-gradient(90deg,var(--blue),#0ea5e9);
    }
    .tiny.danger{
      color:#fff;
      border:none;
      background:linear-gradient(90deg,#b91c1c,#ef4444);
    }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .twoCols{grid-template-columns:1fr} }

    canvas{background:#fff;border:1px solid var(--stroke);border-radius:18px;padding:10px}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="title">
      <b>Reporting Vicidial — Pivot & Statistiques</b>
      <span class="muted" style="color:rgba(255,255,255,.86)">Import  Mapping  Doublons  Stats (Agent/Jour/Semaine/Mois)  Export</span>
    </div>
    <div class="row">
      <span class="badge" id="headerBadge">Aucun fichier</span>
      <button class="btn secondary" id="btnReset">Réinitialiser</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- TOP GRID -->
  <div class="grid">

    <!-- Import / Controls -->
    <div class="card">
      <h2>1) Import & options</h2>

      <div class="row">
        <label class="btn" for="fileInput">Importer fichier Vicidial</label>
        <input id="fileInput" type="file" accept=".csv,.txt,.tsv,.xlsx,.xls,.json" />
        <button class="btn secondary" id="btnMappingManual" disabled>Choix 1 : Mapping manuel</button>
        <button class="btn secondary" id="btnMappingAuto" disabled>Choix 2 : Mapping automatique</button>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="pill" id="fileInfo">Fichier : —</span>
        <span class="pill" id="rowInfo">Lignes : —</span>
        <span class="pill" id="dupInfo">Doublons supprimés : —</span>
      </div>

      <div class="hr"></div>

      <div class="filters">
        <select id="timeMode" disabled>
          <option value="day">Par jour</option>
          <option value="week">Par semaine</option>
          <option value="month">Par mois</option>
        </select>
        <input type="date" id="datePick" disabled />
        <button class="btn secondary" id="btnApplyFilter" disabled>Appliquer</button>
      </div>

      <p class="hint" style="margin:10px 0 0">
         Règle doublons : <b>même numéro + même statut = 1 ligne</b> (on garde la plus récente).<br>
         Champs manuels par ligne : <b>Réponse client 1</b>, <b>Remarque</b>, <b>Informations supplémentaires</b>.
      </p>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnExportXlsx" disabled>Exporter vers Excel</button>
        <button class="btn secondary" id="btnCopyRecap" disabled>Copier récap (HTML accueil)</button>
        <button class="btn secondary" id="btnCapture" disabled>Capturer le récapitulatif</button>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <h2>2) Historique des reportings importés</h2>
      <div class="row">
        <button class="btn secondary" id="btnImportReporting">Importer reporting (JSON)</button>
        <input id="importReportingInput" type="file" accept=".json" />
      </div>
      <div class="hr"></div>
      <div id="historyWrap" class="muted">Aucun historique pour l’instant.</div>
    </div>

  </div>

  <!-- Data table -->
  <div class="card" style="margin-top:14px">
    <h2>3) Données (après mapping + nettoyage)</h2>
    <div class="tableWrap" id="tableWrap">
      <table id="dataTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <p class="hint" style="margin:10px 0 0">
      Astuce : clique dans les champs pour éditer. Les modifications sont sauvegardées automatiquement dans l’historique.
    </p>
  </div>

  <!-- Stats / Charts -->
  <div class="card" style="margin-top:14px" id="recapSection">
    <h2>4) Statistiques & récapitulatif (à copier dans la page d’accueil)</h2>

    <div class="kpis" id="kpiGrid">
      <!-- Filled by JS -->
    </div>

    <div class="twoCols" style="margin-top:14px">
      <div>
        <h2 style="margin:0 0 10px">Diagramme des statuts</h2>
        <canvas id="statusChart" height="250"></canvas>
      </div>
      <div>
        <h2 style="margin:0 0 10px">Statistiques par agent</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Agent</th>
                <th class="cellSmall">Appels</th>
                <th class="cellSmall">Durée totale</th>
                <th class="cellSmall">Durée moyenne</th>
                <th>Top statuts</th>
                <th class="cellSmall">Qualité (Réponse/Remarque/Infos)</th>
              </tr>
            </thead>
            <tbody id="agentTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="hint" style="margin:12px 0 0">
      Le récap ci-dessus est celui que tu peux capturer / copier dans l’accueil.
    </p>
  </div>

</div>

<!-- Mapping Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <div>
        <b id="modalTitle">Mapping</b>
        <div style="font-size:12px; opacity:.86" id="modalSubtitle">Associer les colonnes du fichier à tes champs</div>
      </div>
      <button class="btn secondary" id="btnCloseModal">Fermer</button>
    </div>
    <div class="modalBody">
      <div class="mapGrid">
        <div class="mapBox">
          <h3>Champs Vicidial (source)</h3>
          <div class="mini">Colonnes détectées dans le fichier importé.</div>
          <div class="hr"></div>
          <div id="columnsList" class="mini"></div>
        </div>

        <div class="mapBox">
          <h3>Champs Reporting (cible)</h3>
          <div class="mini">Sélectionne la colonne correspondante. Tu peux sauvegarder ce mapping.</div>
          <div class="hr"></div>

          <div id="mappingForm"></div>

          <div class="hr"></div>
          <div class="right">
            <button class="btn secondary" id="btnSaveMapping">Sauvegarder mapping</button>
            <button class="btn" id="btnApplyMapping">Appliquer</button>
          </div>

          <div class="mini" id="mappingHint" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">OK</div>

<script>
/* =========================
   Storage keys
========================= */
const LS_HISTORY = "vicidial_reporting_history_v1";
const LS_SAVED_MAPPING = "vicidial_reporting_mapping_v1";

/* =========================
   Reporting schema (target fields)
========================= */
const TARGET_FIELDS = [
  {key:"call_date", label:"Date d'appel + heure (source)", required:true},
  {key:"first_name", label:"First name / Prénom", required:false},
  {key:"last_name", label:"Last name / Nom", required:false},
  {key:"phone_fixed", label:"Téléphone fixe (source)", required:false},
  {key:"mobile", label:"Mobile (source)", required:true},
  {key:"address1", label:"Adresse 1", required:false},
  {key:"city", label:"City", required:false},
  {key:"postal_code", label:"Code postal", required:false},
  {key:"comments", label:"Commentaire (source)", required:false},
  {key:"status", label:"Status (source)", required:true},
  {key:"user", label:"Agent (source)", required:true},
  {key:"recording_location", label:"Recording location (source)", required:false},
];

/* Manual editable fields (always present) */
const MANUAL_FIELDS = [
  {key:"reponse_client_1", label:"Réponse client 1"},
  {key:"remarque", label:"Remarque"},
  {key:"infos_supp", label:"Informations supplémentaires"},
];

/* =========================
   State
========================= */
let rawRows = [];         // raw objects from file
let rawColumns = [];      // detected columns
let currentMapping = {};  // targetKey -> sourceColumnName
let normalizedRows = [];  // after mapping, normalization, dedup
let filteredRows = [];    // after date filter
let activeReportId = null;

let statusChart = null;

/* =========================
   Elements
========================= */
const $ = (id)=>document.getElementById(id);

const fileInput = $("fileInput");
const btnMappingManual = $("btnMappingManual");
const btnMappingAuto = $("btnMappingAuto");
const btnExportXlsx = $("btnExportXlsx");
const btnCopyRecap = $("btnCopyRecap");
const btnCapture = $("btnCapture");

const headerBadge = $("headerBadge");
const fileInfo = $("fileInfo");
const rowInfo = $("rowInfo");
const dupInfo = $("dupInfo");

const timeMode = $("timeMode");
const datePick = $("datePick");
const btnApplyFilter = $("btnApplyFilter");

const thead = $("thead");
const tbody = $("tbody");
const agentTbody = $("agentTbody");

const modalBack = $("modalBack");
const columnsList = $("columnsList");
const mappingForm = $("mappingForm");
const mappingHint = $("mappingHint");
const modalTitle = $("modalTitle");

const btnCloseModal = $("btnCloseModal");
const btnSaveMapping = $("btnSaveMapping");
const btnApplyMapping = $("btnApplyMapping");

const btnReset = $("btnReset");
const btnImportReporting = $("btnImportReporting");
const importReportingInput = $("importReportingInput");

const historyWrap = $("historyWrap");
const toast = $("toast");

/* =========================
   Helpers
========================= */
function toastMsg(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1400);
}

function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }

function parseDateTime(dtStr){
  // Vicidial often: "YYYY-MM-DD HH:MM:SS"
  const s = safeStr(dtStr).trim();
  if(!s) return {date:"", time:"", ts:0};
  const [d, t] = s.split(" ");
  const date = d || "";
  const time = t || "";
  const ts = Date.parse((date && time) ? `${date}T${time}` : date) || 0;
  return {date, time, ts};
}

function normalizePhone(s){
  let x = safeStr(s).trim();
  if(!x) return "";
  x = x.replace(/[^\d+]/g, "");
  // remove leading +33 style? keep digits; for dedup better to keep last 9/10
  // We'll keep full digits but strip leading +
  x = x.replace(/^\+/, "");
  return x;
}

function msToHMS(seconds){
  const s = Math.max(0, Number(seconds)||0);
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = Math.floor(s%60);
  const pad = (n)=>String(n).padStart(2,"0");
  if(hh>0) return `${hh}:${pad(mm)}:${pad(ss)}`;
  return `${mm}:${pad(ss)}`;
}

function isoWeekKey(dateStr){
  // returns "YYYY-Www"
  const d = new Date(dateStr+"T00:00:00");
  if(isNaN(d)) return "";
  // ISO week algorithm
  const dayNum = (d.getUTCDay() + 6) % 7;
  d.setUTCDate(d.getUTCDate() - dayNum + 3);
  const firstThursday = new Date(Date.UTC(d.getUTCFullYear(),0,4));
  const firstDayNum = (firstThursday.getUTCDay() + 6) % 7;
  firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDayNum + 3);
  const week = 1 + Math.round((d - firstThursday) / (7*24*3600*1000));
  return `${d.getUTCFullYear()}-W${String(week).padStart(2,"0")}`;
}

function monthKey(dateStr){
  if(!dateStr) return "";
  return dateStr.slice(0,7); // YYYY-MM
}

function getTopEntries(obj, n=3){
  return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n);
}

/* =========================
   Auto mapping (based on typical Vicidial export)
========================= */
function buildAutoMapping(columns){
  const lower = columns.map(c=>c.toLowerCase());
  const pick = (cands)=>{
    for(const cand of cands){
      const i = lower.indexOf(cand.toLowerCase());
      if(i>=0) return columns[i];
    }
    return "";
  };

  // NOTE: export in sample includes: call_date, phone_number_dialed, phone_number, status, user, first_name, last_name, address1, city, postal_code, comments, recording_location, length_in_sec, status_name
  return {
    call_date: pick(["call_date","date","call time","call_datetime"]),
    first_name: pick(["first_name","prenom","first name"]),
    last_name: pick(["last_name","nom","last name"]),
    phone_fixed: pick(["phone_number_dialed","phone_number_dialed ","phone_number_dialed\t","phone_number_dialed\r"]),
    mobile: pick(["phone_number","mobile","tel","telephone","phone"]),
    address1: pick(["address1","adresse1","address_1","adresse"]),
    city: pick(["city","ville"]),
    postal_code: pick(["postal_code","cp","zip"]),
    comments: pick(["comments","commentaire"]),
    status: pick(["status","status_name"]),
    user: pick(["user","agent","username"]),
    recording_location: pick(["recording_location","recording","recording url","recording_location "]),
  };
}

/* =========================
   File parsing
========================= */
async function readFileAsArrayBuffer(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsArrayBuffer(file);
  });
}

async function readFileAsText(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsText(file);
  });
}

function parseDelimitedText(text){
  // detect delimiter: tab or comma or semicolon
  const sampleLine = text.split(/\r?\n/).find(l=>l.trim().length>0) || "";
  const delim = sampleLine.includes("\t") ? "\t" : (sampleLine.includes(";") ? ";" : ",");
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length===0) return {columns:[], rows:[]};

  const cols = lines[0].split(delim).map(c=>c.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split(delim);
    const o = {};
    cols.forEach((c,idx)=>o[c]=parts[idx] ?? "");
    rows.push(o);
  }
  return {columns: cols, rows};
}

function parseSheetToJson(workbook){
  const first = workbook.SheetNames[0];
  const ws = workbook.Sheets[first];
  const json = XLSX.utils.sheet_to_json(ws, {defval:""});
  const cols = json.length ? Object.keys(json[0]) : [];
  return {columns: cols, rows: json};
}

/* =========================
   Normalization + dedup
========================= */
function normalizeWithMapping(rows, mapping){
  // Convert each raw row to a normalized row with required fields + manual fields
  const out = [];
  for(const r of rows){
    const get = (targetKey)=>{
      const src = mapping[targetKey];
      return src ? safeStr(r[src]) : "";
    };

    const call_dt = parseDateTime(get("call_date"));
    const status = safeStr(get("status")).trim();
    const user = safeStr(get("user")).trim();

    const phoneFixed = normalizePhone(get("phone_fixed"));
    const mobile = normalizePhone(get("mobile")) || phoneFixed; // fallback

    // Additional fields from raw if exist (length)
    const length = Number(r["length_in_sec"] ?? r["length"] ?? 0) || 0;
    const statusName = safeStr(r["status_name"] ?? "");

    out.push({
      _raw: r,
      report: {
        call_date: safeStr(get("call_date")),
        call_day: call_dt.date,
        call_time: call_dt.time,
        call_ts: call_dt.ts,

        first_name: safeStr(get("first_name")),
        last_name: safeStr(get("last_name")),

        phone_fixed: phoneFixed,
        mobile: mobile,

        address1: safeStr(get("address1")),
        city: safeStr(get("city")),
        postal_code: safeStr(get("postal_code")),

        comments: safeStr(get("comments")),

        status: status,
        status_name: statusName || status,
        user: user,
        recording_location: safeStr(get("recording_location")),

        length_in_sec: length,
      },
      manual: {
        reponse_client_1: "",
        remarque: "",
        infos_supp: ""
      }
    });
  }
  return out;
}

function dedupByPhoneAndStatus(rows){
  // Rule: same number + same status => keep most recent (highest call_ts)
  const seen = new Map();
  let removed = 0;

  for(const item of rows){
    const ph = item.report.mobile || item.report.phone_fixed || "";
    const key = `${ph}||${item.report.status}`.toLowerCase();
    const prev = seen.get(key);
    if(!prev){
      seen.set(key, item);
    }else{
      // keep the most recent
      if((item.report.call_ts || 0) > (prev.report.call_ts || 0)){
        seen.set(key, item);
      }
      removed++;
    }
  }
  return {rows: Array.from(seen.values()).sort((a,b)=>(a.report.call_ts||0)-(b.report.call_ts||0)), removed};
}

/* =========================
   History storage
========================= */
function loadHistory(){
  try{
    return JSON.parse(localStorage.getItem(LS_HISTORY) || "[]");
  }catch{ return []; }
}
function saveHistory(arr){
  localStorage.setItem(LS_HISTORY, JSON.stringify(arr));
}
function upsertActiveReport(){
  if(!activeReportId) return;

  const hist = loadHistory();
  const idx = hist.findIndex(x=>x.id===activeReportId);
  if(idx<0) return;

  hist[idx].normalizedRows = normalizedRows;
  hist[idx].filtered = {
    timeMode: timeMode.value,
    date: datePick.value
  };
  saveHistory(hist);
  renderHistory();
}

function createNewReportRecord(filename){
  const id = "rep_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  const record = {
    id,
    filename,
    importedAt: new Date().toISOString(),
    rawColumns,
    rawCount: rawRows.length,
    mapping: currentMapping,
    normalizedRows, // stored
    filtered: {timeMode:"day", date:""}
  };
  const hist = loadHistory();
  hist.unshift(record);
  saveHistory(hist);
  activeReportId = id;
  renderHistory();
}

/* =========================
   UI Rendering
========================= */
function setEnabledAfterData(enabled){
  btnExportXlsx.disabled = !enabled;
  btnCopyRecap.disabled = !enabled;
  btnCapture.disabled = !enabled;
  timeMode.disabled = !enabled;
  datePick.disabled = !enabled;
  btnApplyFilter.disabled = !enabled;
}

function renderHistory(){
  const hist = loadHistory();
  if(!hist.length){
    historyWrap.innerHTML = `<div class="muted">Aucun historique pour l’instant.</div>`;
    return;
  }

  const rows = hist.map(h=>{
    const dt = new Date(h.importedAt);
    const when = isNaN(dt) ? h.importedAt : dt.toLocaleString();
    const active = (h.id===activeReportId);
    return `
      <tr ${active ? `style="background:#f2f7ff"` : ""}>
        <td><b>${escapeHtml(h.filename)}</b><div class="muted" style="font-size:11px">Importé : ${escapeHtml(when)}</div></td>
        <td class="cellSmall">${h.rawCount}</td>
        <td class="cellSmall">${(h.normalizedRows||[]).length}</td>
        <td class="cellSmall">${escapeHtml((h.mapping && Object.keys(h.mapping).length) ? "OK" : "—")}</td>
        <td>
          <div class="smallActions">
            <button class="tiny primary" data-act="open" data-id="${h.id}">Ouvrir</button>
            <button class="tiny" data-act="exportjson" data-id="${h.id}">Exporter JSON</button>
            <button class="tiny danger" data-act="delete" data-id="${h.id}">Supprimer</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  historyWrap.innerHTML = `
    <div class="tableWrap" style="border:none; box-shadow:none">
      <table class="histTable">
        <thead>
          <tr>
            <th>Fichier</th>
            <th class="cellSmall">Brut</th>
            <th class="cellSmall">Net</th>
            <th class="cellSmall">Mapping</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  historyWrap.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if(act==="delete") deleteHistory(id);
      if(act==="open") openHistory(id);
      if(act==="exportjson") exportHistoryJSON(id);
    });
  });
}

function escapeHtml(s){
  return safeStr(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function openHistory(id){
  const hist = loadHistory();
  const h = hist.find(x=>x.id===id);
  if(!h) return;

  activeReportId = id;
  rawColumns = h.rawColumns || [];
  currentMapping = h.mapping || {};
  normalizedRows = h.normalizedRows || [];
  headerBadge.textContent = `Actif : ${h.filename}`;
  fileInfo.textContent = `Fichier : ${h.filename}`;
  rowInfo.textContent = `Lignes : ${h.rawCount} brut / ${(normalizedRows||[]).length} net`;
  dupInfo.textContent = `Doublons supprimés : —`;

  // restore filters
  timeMode.value = (h.filtered && h.filtered.timeMode) ? h.filtered.timeMode : "day";
  datePick.value = (h.filtered && h.filtered.date) ? h.filtered.date : "";

  applyFiltersAndRender();
  setEnabledAfterData(true);
  btnMappingManual.disabled = false;
  btnMappingAuto.disabled = false;

  renderHistory();
  toastMsg("Reporting chargé");
}

function deleteHistory(id){
  const hist = loadHistory().filter(x=>x.id!==id);
  saveHistory(hist);
  if(activeReportId===id){
    activeReportId = null;
    normalizedRows = [];
    filteredRows = [];
    renderTable([]);
    renderStats([]);
    headerBadge.textContent = "Aucun fichier";
    fileInfo.textContent = "Fichier : —";
    rowInfo.textContent = "Lignes : —";
    dupInfo.textContent = "Doublons supprimés : —";
    setEnabledAfterData(false);
  }
  renderHistory();
  toastMsg("Supprimé");
}

function exportHistoryJSON(id){
  const hist = loadHistory();
  const h = hist.find(x=>x.id===id);
  if(!h) return;
  const blob = new Blob([JSON.stringify(h, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${(h.filename||"reporting").replace(/\.[^.]+$/,"")}_reporting.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function renderTable(items){
  const headers = [
    "Date", "Heure", "Agent", "Statut", "Durée",
    "Prénom", "Nom",
    "Téléphone fixe", "Mobile",
    "Adresse 1", "City", "Code postal",
    "Commentaire (Vicidial)",
    "Réponse client 1", "Remarque", "Informations supplémentaires",
    "Enregistrement"
  ];

  thead.innerHTML = `
    <tr>
      ${headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("")}
    </tr>
  `;

  tbody.innerHTML = items.map((item, idx)=>{
    const r = item.report, m = item.manual;
    const rec = safeStr(r.recording_location).trim();
    const recCell = rec ? `<a class="link" href="${escapeHtml(rec)}" target="_blank" rel="noopener">Écouter</a>` : `<span class="muted">—</span>`;

    return `
      <tr data-idx="${idx}">
        <td class="cellSmall">${escapeHtml(r.call_day||"")}</td>
        <td class="cellSmall">${escapeHtml(r.call_time||"")}</td>
        <td class="cellSmall"><b>${escapeHtml(r.user||"")}</b></td>
        <td class="cellSmall"><span class="statusTag">${escapeHtml(r.status_name || r.status || "")}</span></td>
        <td class="cellSmall">${escapeHtml(msToHMS(r.length_in_sec||0))}</td>

        <td>${escapeHtml(r.first_name||"")}</td>
        <td>${escapeHtml(r.last_name||"")}</td>

        <td class="cellSmall">${escapeHtml(r.phone_fixed||"")}</td>
        <td class="cellSmall">${escapeHtml(r.mobile||"")}</td>

        <td>${escapeHtml(r.address1||"")}</td>
        <td>${escapeHtml(r.city||"")}</td>
        <td class="cellSmall">${escapeHtml(r.postal_code||"")}</td>

        <td>${escapeHtml(r.comments||"")}</td>

        <td>
          <input class="in" data-field="reponse_client_1" value="${escapeHtml(m.reponse_client_1||"")}" placeholder="Saisir..." />
        </td>
        <td>
          <textarea class="in" data-field="remarque" placeholder="Saisir...">${escapeHtml(m.remarque||"")}</textarea>
        </td>
        <td>
          <textarea class="in" data-field="infos_supp" placeholder="Saisir...">${escapeHtml(m.infos_supp||"")}</textarea>
        </td>

        <td class="cellSmall">${recCell}</td>
      </tr>
    `;
  }).join("");

  // bind edits (autosave)
  tbody.querySelectorAll(".in").forEach(el=>{
    el.addEventListener("input", ()=>{
      const tr = el.closest("tr");
      const idx = Number(tr.getAttribute("data-idx"));
      const field = el.getAttribute("data-field");
      if(!Number.isFinite(idx) || !field) return;
      filteredRows[idx].manual[field] = el.value;

      // also update same object inside normalizedRows (reference is same) — but in case, ensure:
      upsertActiveReport();
    });
  });
}

function renderStats(items){
  // KPIs global
  const total = items.length;
  const totalDur = items.reduce((s,x)=>s+(Number(x.report.length_in_sec)||0), 0);
  const avgDur = total ? (totalDur/total) : 0;

  const filledResp = items.filter(x=>safeStr(x.manual.reponse_client_1).trim().length>0).length;
  const filledRem = items.filter(x=>safeStr(x.manual.remarque).trim().length>0).length;
  const filledInf = items.filter(x=>safeStr(x.manual.infos_supp).trim().length>0).length;
  const pct = (n)=> total ? Math.round((n/total)*100) : 0;

  // Status distribution
  const byStatus = {};
  for(const x of items){
    const s = safeStr(x.report.status_name || x.report.status).trim() || "—";
    byStatus[s] = (byStatus[s]||0) + 1;
  }

  // Agents stats
  const byAgent = {};
  for(const x of items){
    const a = safeStr(x.report.user).trim() || "—";
    if(!byAgent[a]) byAgent[a] = {
      calls:0, dur:0, statuses:{},
      resp:0, rem:0, inf:0
    };
    byAgent[a].calls++;
    byAgent[a].dur += (Number(x.report.length_in_sec)||0);
    const st = safeStr(x.report.status_name || x.report.status).trim() || "—";
    byAgent[a].statuses[st] = (byAgent[a].statuses[st]||0)+1;

    if(safeStr(x.manual.reponse_client_1).trim()) byAgent[a].resp++;
    if(safeStr(x.manual.remarque).trim()) byAgent[a].rem++;
    if(safeStr(x.manual.infos_supp).trim()) byAgent[a].inf++;
  }

  // KPIs UI
  const rangeLabel = buildRangeLabel(items);
  const kpis = [
    {label:"Période", value: rangeLabel || "—", sub:"filtre actif"},
    {label:"Appels (net)", value: String(total), sub:"après dédoublonnage"},
    {label:"Durée totale", value: msToHMS(totalDur), sub:"toutes lignes"},
    {label:"Durée moyenne", value: msToHMS(avgDur), sub:"par appel"},
    {label:"Réponse client 1", value: `${filledResp} (${pct(filledResp)}%)`, sub:"fiches renseignées"},
    {label:"Remarque / Infos", value: `${filledRem}/${filledInf}`, sub:`${pct(filledRem)}% / ${pct(filledInf)}%`},
  ];

  $("kpiGrid").innerHTML = kpis.map(k=>`
    <div class="kpi">
      <div class="label">${escapeHtml(k.label)}</div>
      <div class="value">${escapeHtml(k.value)}</div>
      <div class="sub">${escapeHtml(k.sub)}</div>
    </div>
  `).join("");

  // Status chart
  const labels = Object.keys(byStatus);
  const values = labels.map(l=>byStatus[l]);

  if(statusChart){
    statusChart.data.labels = labels;
    statusChart.data.datasets[0].data = values;
    statusChart.update();
  }else{
    statusChart = new Chart($("statusChart"), {
      type: "bar",
      data: {
        labels,
        datasets: [{label:"Nombre", data: values}]
      },
      options: {
        responsive:true,
        plugins: {legend:{display:false}},
        scales: {
          y: {beginAtZero:true, ticks:{precision:0}}
        }
      }
    });
  }

  // Agent table
  const agentRows = Object.entries(byAgent)
    .sort((a,b)=>b[1].calls - a[1].calls)
    .map(([agent, st])=>{
      const avg = st.calls ? (st.dur/st.calls) : 0;
      const top = getTopEntries(st.statuses, 3).map(([k,v])=>`${k} (${v})`).join(" • ");
      const q = `${st.resp}/${st.rem}/${st.inf}`;
      const qp = total ? "" : "";
      return `
        <tr>
          <td><b>${escapeHtml(agent)}</b></td>
          <td class="cellSmall">${st.calls}</td>
          <td class="cellSmall">${escapeHtml(msToHMS(st.dur))}</td>
          <td class="cellSmall">${escapeHtml(msToHMS(avg))}</td>
          <td>${escapeHtml(top || "—")}</td>
          <td class="cellSmall">${escapeHtml(q)}</td>
        </tr>
      `;
    }).join("");

  agentTbody.innerHTML = agentRows || `<tr><td colspan="6" class="muted">Aucune donnée.</td></tr>`;
}

function buildRangeLabel(items){
  if(!items.length) return "";
  const dates = items.map(x=>x.report.call_day).filter(Boolean).sort();
  if(!dates.length) return "";
  const min = dates[0], max = dates[dates.length-1];
  if(min===max) return min;
  return `${min}  ${max}`;
}

/* =========================
   Filters
========================= */
function applyFiltersAndRender(){
  if(!normalizedRows.length){
    filteredRows = [];
    renderTable([]);
    renderStats([]);
    return;
  }

  const mode = timeMode.value;
  const picked = datePick.value; // YYYY-MM-DD

  if(!picked){
    filteredRows = [...normalizedRows];
  }else{
    if(mode==="day"){
      filteredRows = normalizedRows.filter(x=>x.report.call_day===picked);
    }else if(mode==="week"){
      const wk = isoWeekKey(picked);
      filteredRows = normalizedRows.filter(x=>isoWeekKey(x.report.call_day)===wk);
    }else{
      const mk = monthKey(picked);
      filteredRows = normalizedRows.filter(x=>monthKey(x.report.call_day)===mk);
    }
  }

  renderTable(filteredRows);
  renderStats(filteredRows);
  upsertActiveReport();
}

/* =========================
   Modal mapping UI
========================= */
function openMappingModal(kind){
  modalTitle.textContent = (kind==="manual") ? "Mapping manuel" : "Mapping (pré-rempli auto)";
  columnsList.innerHTML = rawColumns.length
    ? rawColumns.map(c=>`• <b>${escapeHtml(c)}</b>`).join("<br>")
    : "<span class='muted'>Aucune colonne détectée</span>";

  // Build form
  mappingForm.innerHTML = TARGET_FIELDS.map(tf=>{
    const options = ['<option value="">—</option>']
      .concat(rawColumns.map(c=>{
        const sel = (currentMapping[tf.key]===c) ? "selected" : "";
        return `<option value="${escapeHtml(c)}" ${sel}>${escapeHtml(c)}</option>`;
      }))
      .join("");

    const required = tf.required ? " (obligatoire)" : "";
    return `
      <div class="mapRow">
        <label>${escapeHtml(tf.label)}${escapeHtml(required)}</label>
        <select data-target="${escapeHtml(tf.key)}">${options}</select>
      </div>
    `;
  }).join("");

  mappingHint.innerHTML = `
    Doublons : <b>même numéro + même statut</b>  1 seule ligne.<br>
    Numéro utilisé : <b>Mobile</b> (sinon Téléphone fixe).<br>
    Après application : stats + table + export sont disponibles.
  `;

  // Update mapping on change
  mappingForm.querySelectorAll("select[data-target]").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const key = sel.getAttribute("data-target");
      currentMapping[key] = sel.value;
    });
  });

  modalBack.style.display = "flex";
}

function closeModal(){
  modalBack.style.display = "none";
}

function mappingIsValid(){
  // required fields must be mapped
  for(const tf of TARGET_FIELDS){
    if(tf.required && !currentMapping[tf.key]) return false;
  }
  return true;
}

function saveMapping(){
  localStorage.setItem(LS_SAVED_MAPPING, JSON.stringify(currentMapping));
  toastMsg("Mapping sauvegardé");
}

/* =========================
   Export XLSX
========================= */
function exportXlsx(){
  if(!filteredRows.length){
    toastMsg("Aucune donnée à exporter");
    return;
  }

  const exportRows = filteredRows.map(x=>{
    const r = x.report, m = x.manual;
    return {
      "Date d'appel": r.call_day,
      "Heure": r.call_time,
      "Agent": r.user,
      "Statut": r.status_name || r.status,
      "Durée (sec)": r.length_in_sec,

      "Prénom": r.first_name,
      "Nom": r.last_name,
      "Téléphone fixe": r.phone_fixed,
      "Mobile": r.mobile,

      "Adresse 1": r.address1,
      "City": r.city,
      "Code postal": r.postal_code,

      "Commentaire (Vicidial)": r.comments,

      "Réponse client 1": m.reponse_client_1,
      "Remarque": m.remarque,
      "Informations supplémentaires": m.infos_supp,

      "Recording location": r.recording_location
    };
  });

  const ws = XLSX.utils.json_to_sheet(exportRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "REPORTING");

  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_");
  XLSX.writeFile(wb, `REPORTING_${stamp}.xlsx`);
}

/* =========================
   Copy recap HTML (for homepage)
========================= */
async function copyRecapHTML(){
  const recapEl = $("recapSection");
  const kpis = Array.from(recapEl.querySelectorAll(".kpi")).map(k=>{
    const label = k.querySelector(".label")?.textContent?.trim() || "";
    const value = k.querySelector(".value")?.textContent?.trim() || "";
    const sub = k.querySelector(".sub")?.textContent?.trim() || "";
    return {label, value, sub};
  });

  // Simple embeddable snippet
  const html = `
<div class="reporting-kpis" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
  ${kpis.map(k=>`
  <div style="border:1px solid rgba(15,23,42,.10);border-radius:16px;padding:10px;background:#fff">
    <div style="font-size:11px;opacity:.7;font-weight:800">${escapeHtml(k.label)}</div>
    <div style="font-size:18px;font-weight:900;margin-top:2px">${escapeHtml(k.value)}</div>
    <div style="font-size:11px;opacity:.7;margin-top:2px">${escapeHtml(k.sub)}</div>
  </div>
  `).join("")}
</div>`.trim();

  await navigator.clipboard.writeText(html);
  toastMsg("Récap copié (HTML)");
}

/* =========================
   Capture recap
========================= */
async function captureRecap(){
  const el = $("recapSection");
  const canvas = await html2canvas(el, {scale:2, backgroundColor:"#ffffff"});
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_");
  a.download = `RECAP_REPORTING_${stamp}.png`;
  a.click();
  toastMsg("Capture téléchargée");
}

/* =========================
   Import reporting JSON
========================= */
function importReportingJsonFile(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result);
      if(!obj || !obj.id || !obj.normalizedRows){
        toastMsg("JSON invalide");
        return;
      }
      // Put new ID to avoid collisions
      obj.id = "rep_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      obj.importedAt = new Date().toISOString();
      const hist = loadHistory();
      hist.unshift(obj);
      saveHistory(hist);
      renderHistory();
      toastMsg("Reporting importé");
    }catch{
      toastMsg("Erreur JSON");
    }
  };
  r.readAsText(file);
}

/* =========================
   Main: file input handling
========================= */
fileInput.addEventListener("change", async ()=>{
  const file = fileInput.files && fileInput.files[0];
  if(!file) return;

  const name = file.name || "fichier";
  headerBadge.textContent = `Chargé : ${name}`;
  fileInfo.textContent = `Fichier : ${name}`;

  // reset temp state
  rawRows = [];
  rawColumns = [];
  currentMapping = {};
  normalizedRows = [];
  filteredRows = [];

  // If JSON, treat as reporting import (shortcut)
  if(name.toLowerCase().endsWith(".json")){
    importReportingJsonFile(file);
    fileInput.value = "";
    return;
  }

  try{
    if(name.toLowerCase().endsWith(".xlsx") || name.toLowerCase().endsWith(".xls")){
      const buf = await readFileAsArrayBuffer(file);
      const wb = XLSX.read(buf, {type:"array"});
      const parsed = parseSheetToJson(wb);
      rawRows = parsed.rows;
      rawColumns = parsed.columns;
    }else{
      const text = await readFileAsText(file);
      const parsed = parseDelimitedText(text);
      rawRows = parsed.rows;
      rawColumns = parsed.columns;
    }

    rowInfo.textContent = `Lignes : ${rawRows.length} brut`;
    dupInfo.textContent = `Doublons supprimés : —`;

    // Load saved mapping if exists
    let saved = {};
    try{ saved = JSON.parse(localStorage.getItem(LS_SAVED_MAPPING) || "{}"); }catch{}
    // keep only mappings that exist in current columns
    const cleaned = {};
    for(const k of Object.keys(saved||{})){
      if(rawColumns.includes(saved[k])) cleaned[k] = saved[k];
    }
    currentMapping = cleaned;

    btnMappingManual.disabled = false;
    btnMappingAuto.disabled = false;

    toastMsg("Fichier prêt : choisis mapping");
  }catch(err){
    console.error(err);
    toastMsg("Erreur import fichier");
  }finally{
    fileInput.value = "";
  }
});

/* Buttons */
btnMappingManual.addEventListener("click", ()=>{
  if(!rawRows.length) return;
  openMappingModal("manual");
});

btnMappingAuto.addEventListener("click", ()=>{
  if(!rawRows.length) return;
  const auto = buildAutoMapping(rawColumns);
  // keep only existing
  for(const k of Object.keys(auto)){
    if(auto[k]) currentMapping[k] = auto[k];
  }
  openMappingModal("auto");
});

btnCloseModal.addEventListener("click", closeModal);
modalBack.addEventListener("click", (e)=>{
  if(e.target===modalBack) closeModal();
});

btnSaveMapping.addEventListener("click", saveMapping);

btnApplyMapping.addEventListener("click", ()=>{
  if(!mappingIsValid()){
    toastMsg("Mapping incomplet (champs obligatoires)");
    return;
  }

  // normalize + dedup
  const normalized = normalizeWithMapping(rawRows, currentMapping);
  const ded = dedupByPhoneAndStatus(normalized);
  normalizedRows = ded.rows;
  const removed = ded.removed;

  rowInfo.textContent = `Lignes : ${rawRows.length} brut / ${normalizedRows.length} net`;
  dupInfo.textContent = `Doublons supprimés : ${removed}`;

  // Default date filter: set to first date (or empty)
  const dates = normalizedRows.map(x=>x.report.call_day).filter(Boolean).sort();
  datePick.value = dates.length ? dates[0] : "";

  // Create a report record in history
  createNewReportRecord(fileInfo.textContent.replace("Fichier : ",""));

  // render
  setEnabledAfterData(true);
  applyFiltersAndRender();

  closeModal();
  toastMsg("Mapping appliqué");
});

btnApplyFilter.addEventListener("click", ()=>{
  applyFiltersAndRender();
  toastMsg("Filtre appliqué");
});

btnExportXlsx.addEventListener("click", exportXlsx);
btnCopyRecap.addEventListener("click", ()=>{
  copyRecapHTML().catch(()=>toastMsg("Copie impossible"));
});
btnCapture.addEventListener("click", ()=>{
  captureRecap().catch(()=>toastMsg("Capture impossible"));
});

btnReset.addEventListener("click", ()=>{
  if(confirm("Réinitialiser l’affichage (sans supprimer l’historique) ?")){
    rawRows = [];
    rawColumns = [];
    currentMapping = {};
    normalizedRows = [];
    filteredRows = [];
    activeReportId = null;

    headerBadge.textContent = "Aucun fichier";
    fileInfo.textContent = "Fichier : —";
    rowInfo.textContent = "Lignes : —";
    dupInfo.textContent = "Doublons supprimés : —";

    btnMappingManual.disabled = true;
    btnMappingAuto.disabled = true;
    setEnabledAfterData(false);

    renderTable([]);
    renderStats([]);

    toastMsg("Réinitialisé");
  }
});

btnImportReporting.addEventListener("click", ()=>{
  importReportingInput.click();
});
importReportingInput.addEventListener("change", ()=>{
  const f = importReportingInput.files && importReportingInput.files[0];
  if(!f) return;
  importReportingJsonFile(f);
  importReportingInput.value = "";
});

/* Init */
(function init(){
  renderHistory();
  renderTable([]);
  renderStats([]);
  setEnabledAfterData(false);
  btnMappingManual.disabled = true;
  btnMappingAuto.disabled = true;
})();
</script>

</body>
</html>